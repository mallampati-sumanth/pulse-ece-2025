<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Events Management - Admin Panel</title>
    <link rel="stylesheet" href="/styles/admin.css">
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
</head>
<body>
    <!-- Mobile Toggle Button -->
    <button class="toggle-btn">
        <ion-icon name="menu-outline"></ion-icon>
    </button>

    <!-- Header -->
    <%- include('partials/adminHeader') %>
    
    <!-- Admin Sidebar -->
    <%- include('partials/adminSidebar') %>
    
    <main>
        <div class="admin-header">
            <h1>Events Management</h1>
            <div class="admin-actions">
                <button onclick="sendAllReminders()" class="btn-admin btn-info">
                    <ion-icon name="notifications-outline"></ion-icon>
                    Send Tomorrow's Reminders
                </button>
                <a href="/admin/events/create" class="btn-admin btn-primary">
                    <ion-icon name="add-circle-outline"></ion-icon>
                    Create New Event
                </a>
            </div>
        </div>

        <div class="admin-content">
            <% if (events && events.length > 0) { %>
                <div class="admin-table">
                    <table>
                        <thead>
                            <tr>
                                <th>Image</th>
                                <th>Title</th>
                                <th>Date</th>
                                <th>Time</th>
                                <th>Venue</th>
                                <th>Capacity</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            <% events.forEach(event => { %>
                                <tr>
                                    <td data-label="Image">
                                        <div class="event-image">
                                            <% if (event.image && event.image !== 'default-event.jpg') { %>
                                                <img src="/uploads/events/<%= event.image %>" alt="<%= event.title %>" class="event-poster">
                                            <% } else { %>
                                                <div class="no-image">
                                                    <ion-icon name="image-outline"></ion-icon>
                                                </div>
                                            <% } %>
                                        </div>
                                    </td>
                                    <td data-label="Title"><%= event.title %></td>
                                    <td data-label="Date"><%= new Date(event.date).toLocaleDateString() %></td>
                                    <td data-label="Time"><%= event.time %></td>
                                    <td data-label="Venue"><%= event.venue %></td>
                                    <td data-label="Capacity"><%= event.capacity %></td>
                                    <td data-label="Actions">
                                        <div class="operations">
                                            <a href="/admin/events/<%= event._id %>/edit" class="btn-admin btn-warning">
                                                <ion-icon name="create-outline"></ion-icon>
                                                Edit
                                            </a>
                                            <button onclick="sendEventEmails('<%= event._id %>', 'confirmation')" class="btn-admin btn-info">
                                                <ion-icon name="mail-outline"></ion-icon>
                                                Send Emails
                                            </button>
                                            <button onclick="sendEventEmails('<%= event._id %>', 'reminder')" class="btn-admin btn-secondary">
                                                <ion-icon name="alarm-outline"></ion-icon>
                                                Send Reminders
                                            </button>
                                            <form method="POST" action="/admin/events/<%= event._id %>/delete" style="display: inline;">
                                                <button type="submit" class="btn-admin btn-danger" onclick="return confirm('Are you sure you want to delete this event?')">
                                                    <ion-icon name="trash-outline"></ion-icon>
                                                    Delete
                                                </button>
                                            </form>
                                        </div>
                                    </td>
                                </tr>
                            <% }); %>
                        </tbody>
                    </table>
                </div>
            <% } else { %>
                <div class="empty-state">
                    <ion-icon name="calendar-outline"></ion-icon>
                    <h3>No Events Found</h3>
                    <p>Start by creating your first event to engage with students and faculty.</p>
                    <a href="/admin/events/create" class="btn-admin btn-primary">Create First Event</a>
                </div>
            <% } %>
        </div>
    </main>
    <!-- Scripts -->
    <script type="module" src="https://unpkg.com/ionicons@7.1.0/dist/ionicons/ionicons.esm.js"></script>
    <script nomodule src="https://unpkg.com/ionicons@7.1.0/dist/ionicons/ionicons.js"></script>
    <script>
        // Mobile menu toggle
        const toggle_btn = document.querySelector('.toggle-btn');
        const aside_container = document.querySelector('.aside_container');
        
        if (toggle_btn && aside_container) {
            toggle_btn.addEventListener('click', () => {
                aside_container.classList.toggle('active');
            });
        }

        // Delete event function
        function deleteEvent(eventId) {
            if (confirm('Are you sure you want to delete this event? This action cannot be undone.')) {
                fetch(`/admin/events/delete/${eventId}`, {
                    method: 'DELETE',
                    headers: {
                        'Content-Type': 'application/json',
                    }
                })
                .then(response => {
                    if (response.ok) {
                        window.location.reload();
                    } else {
                        alert('Error deleting event');
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    alert('Error deleting event');
                });
            }
        }

        // Send event emails function
        function sendEventEmails(eventId, emailType) {
            const action = emailType === 'reminder' ? 'send reminder emails' : 'send confirmation emails';
            
            if (confirm(`Are you sure you want to ${action} to all registered participants for this event?`)) {
                // Show loading state
                const button = event.target;
                const originalText = button.innerHTML;
                button.innerHTML = '<ion-icon name="hourglass-outline"></ion-icon> Sending...';
                button.disabled = true;

                fetch('/admin/events/send-emails', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ 
                        eventId: eventId,
                        emailType: emailType 
                    })
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        alert(data.message);
                    } else {
                        alert('Error: ' + (data.error || 'Failed to send emails'));
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    alert('Error sending emails');
                })
                .finally(() => {
                    // Reset button state
                    button.innerHTML = originalText;
                    button.disabled = false;
                });
            }
        }

        // Send bulk reminders for all upcoming events
        function sendAllReminders() {
            if (confirm('Send reminder emails for all events happening tomorrow?')) {
                fetch('/admin/events/send-reminders', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    }
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        alert(data.message);
                    } else {
                        alert('Error: ' + (data.error || 'Failed to send reminders'));
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    alert('Error sending reminders');
                });
            }
        }
    </script>
</body>
</html>
